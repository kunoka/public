{"version":3,"sources":["../../wechat/g.js"],"names":["sha1","require","Promise","request","promisify","prefix","api","accessToken","Wechat","opts","that","appID","appSecret","getAccessToken","saveAccessToken","then","data","JSON","parse","e","updateAccessToken","isValidAccessToken","resolve","access_token","expires_in","prototype","acces_token","now","Date","getTime","url","console","log","reject","json","response","body","module","exports","wechat","ctx","next","query","token","signature","nonce","timestamp","echostr","str","sort","join","sha"],"mappings":"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","file":"g.js","sourcesContent":["var sha1 = require('sha1')\nvar Promise = require('bluebird')\nvar request = Promise.promisify(require('request'))\n// var request = require('request')\nvar prefix = 'https://api.weixin.qq.com/cgi-bin/'\nvar api = {\n  accessToken: prefix + 'token?grant_type=client_credential'\n}\nfunction Wechat(opts) {\n  var that = this\n  this.appID = opts.appID\n  this.appSecret = opts.appSecret\n  this.getAccessToken = opts.getAccessToken\n  this.saveAccessToken = opts.saveAccessToken\n  this.getAccessToken()\n    .then(function(data) {\n      try {\n        data = JSON.parse(data)\n      }\n      catch (e) {\n        return that.updateAccessToken(data)\n      }\n      if (that.isValidAccessToken(data)) {\n        Promise.resolve(data)\n      }\n      else {\n        return that.updateAccessToken()\n      }\n    })\n    .then(function (data) {\n      that.access_token = data.access_token\n      that.expires_in = data.expires_in\n      that.saveAccessToken(data)\n    })\n}\n\nWechat.prototype.isValidAccessToken = function (data) {\n  if(!data || !data.acces_token || !data.expires_in) {\n    return false\n  }\n  var access_token = data.acces_token\n  var expires_in = data.expires_in\n  var now = (new Date().getTime())\n  if( now < expires_in) {\n    return true\n  }\n  else{\n    return false\n  }\n}\n\nWechat.prototype.updateAccessToken = function () {\n  var appID = this.appID\n  var appSecret = this.appSecret\n  var url = api.accessToken + '&appid=' + appID + '&secret=' + appSecret\n  console.log(url)\n  return new Promise(function (resolve, reject) {\n    request({\n      url: url,\n      json: true\n    }).then(function (response) {\n      debugger\n      console.log(response.body)\n      var data = response.body\n      var now = new Date().getTime()\n      var expires_in = now + (data.expires_in - 20) * 1000\n      data.expires_in = expires_in\n      resolve(data)\n    })\n  })\n}\nmodule.exports = function(opts){\n  var wechat = new Wechat(opts)\n  return async (ctx, next)=> {\n    console.log('===opts===')\n    console.log(opts)\n    console.log('ctx.query')\n    console.log(ctx.query)\n    var token = opts.token\n    var signature = ctx.query.signature\n    console.log('signature')\n    console.log(signature)\n    var nonce = ctx.query.nonce\n    var timestamp = ctx.query.timestamp\n    var echostr = ctx.query.echostr\n    var str = [token, timestamp, nonce].sort().join('')\n    var sha = sha1(str)\n    console.log('sha')\n    console.log(sha)\n    if(sha === signature) {\n      ctx.body = echostr + ''\n    }else{\n      ctx.body = 'wrong'\n    }\n    await next();\n  }\n}"]}