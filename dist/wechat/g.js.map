{"version":3,"sources":["../../wechat/g.js"],"names":["sha1","require","getRawBody","Wechat","util","module","exports","opts","wechat","ctx","next","that","token","signature","query","nonce","timestamp","echostr","str","sort","join","sha","console","log","method","body","req","length","limit","encoding","charset","data","parseXMLAsync","content","message","formatMessage","xml","MsgType","Event","now","Date","getTime","status","type","reply","FromUserName","ToUserName"],"mappings":"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","file":"g.js","sourcesContent":["var sha1 = require('sha1')\nvar getRawBody = require('raw-body')\nvar Wechat = require('./wechat')\nvar util = require('./util')\nmodule.exports = function(opts){\n  var wechat = new Wechat(opts)\n\n  return async (ctx, next)=> {\n    var that = ctx\n    var token = opts.token\n    var signature = ctx.query.signature\n    var nonce = ctx.query.nonce\n    var timestamp = ctx.query.timestamp\n    var echostr = ctx.query.echostr\n    var str = [token, timestamp, nonce].sort().join('')\n    var sha = sha1(str)\n\n    console.log('sha', sha)\n    console.log(ctx)\n    if(ctx.method === 'GET') {\n      if(sha === signature) {\n        ctx.body = echostr + ''\n      }else{\n        ctx.body = 'wrong'\n      }\n    }else if(ctx.method === 'POST') {\n      if(sha !== signature) {\n        ctx.body = 'wrong'\n        return false\n      }else{\n        var data = await getRawBody(ctx.req, {\n          length: ctx.length,\n          limit: '1mb',\n          encoding: ctx.charset\n        })\n        var content = await util.parseXMLAsync(data)\n        console.log(content)\n        var message = util.formatMessage(content.xml)\n        console.log('==============')\n        console.log(message)\n\n        if (message.MsgType === 'event') {\n          if (message.Event === 'subscribe') {\n            var now = new Date().getTime()\n            that.status = 200\n            that.type = 'application/xml'\n            // var reply = '<xml>\n            //             <ToUserName><![CDATA[' + message.FromUserName + ']]></ToUserName>\n            //             <FromUserName><![CDATA[' + message.ToUserName + ']]></FromUserName>\n            //             <CreateTime>' + now + '</CreateTime>\n            //             <MsgType><![CDATA[text]]></MsgType>\n            //             <Content><![CDATA[Hi, 欢迎来到葡萄的测试账号]]></Content>\n            //             </xml>'\n            var reply = '<xml>'+\n                        '<ToUserName><![CDATA[' + message.FromUserName + ']]></ToUserName>' +\n                        '<FromUserName><![CDATA[' + message.ToUserName + ']]></FromUserName>' +\n                        '<CreateTime>' + now + '</CreateTime>' +\n                        '<MsgType><![CDATA[text]]></MsgType>' +\n                        '<Content><![CDATA[Hi, 欢迎来到葡萄的测试账号]]></Content>' +\n                        '</xml>'\n            console.log('---------------')\n            console.log(reply)\n            that.body = reply\n            return\n          }\n        }\n      }\n    }\n    await next();\n  }\n}"]}