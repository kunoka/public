{"version":3,"sources":["../../wechat/wechat.js"],"names":["Promise","require","request","promisify","prefix","api","accessToken","Wechat","opts","that","appID","appSecret","getAccessToken","saveAccessToken","then","data","JSON","parse","e","updateAccessToken","isValidAccessToken","resolve","access_token","expires_in","prototype","acces_token","now","Date","getTime","url","console","log","reject","json","response","body","module","exports"],"mappings":";;AAAA,IAAIA,UAAUC,QAAQ,UAAR,CAAd;AACA,IAAIC,UAAUF,QAAQG,SAAR,CAAkBF,QAAQ,SAAR,CAAlB,CAAd;AACA;AACA,IAAIG,SAAS,oCAAb;AACA,IAAIC,MAAM;AACRC,eAAaF,SAAS;AADd,CAAV;AAGA,SAASG,MAAT,CAAgBC,IAAhB,EAAsB;AACpB,MAAIC,OAAO,IAAX;AACA,OAAKC,KAAL,GAAaF,KAAKE,KAAlB;AACA,OAAKC,SAAL,GAAiBH,KAAKG,SAAtB;AACA,OAAKC,cAAL,GAAsBJ,KAAKI,cAA3B;AACA,OAAKC,eAAL,GAAuBL,KAAKK,eAA5B;AACA,OAAKD,cAAL,GACGE,IADH,CACQ,UAASC,IAAT,EAAe;AACnB,QAAI;AACFA,aAAOC,KAAKC,KAAL,CAAWF,IAAX,CAAP;AACD,KAFD,CAGA,OAAOG,CAAP,EAAU;AACR,aAAOT,KAAKU,iBAAL,CAAuBJ,IAAvB,CAAP;AACD;AACD,QAAIN,KAAKW,kBAAL,CAAwBL,IAAxB,CAAJ,EAAmC;AACjCf,cAAQqB,OAAR,CAAgBN,IAAhB;AACD,KAFD,MAGK;AACH,aAAON,KAAKU,iBAAL,EAAP;AACD;AACF,GAdH,EAeGL,IAfH,CAeQ,UAAUC,IAAV,EAAgB;AACpBN,SAAKa,YAAL,GAAoBP,KAAKO,YAAzB;AACAb,SAAKc,UAAL,GAAkBR,KAAKQ,UAAvB;AACAd,SAAKI,eAAL,CAAqBE,IAArB;AACD,GAnBH;AAoBD;;AAEDR,OAAOiB,SAAP,CAAiBJ,kBAAjB,GAAsC,UAAUL,IAAV,EAAgB;AACpD,MAAG,CAACA,IAAD,IAAS,CAACA,KAAKU,WAAf,IAA8B,CAACV,KAAKQ,UAAvC,EAAmD;AACjD,WAAO,KAAP;AACD;AACD,MAAID,eAAeP,KAAKU,WAAxB;AACA,MAAIF,aAAaR,KAAKQ,UAAtB;AACA,MAAIG,MAAO,IAAIC,IAAJ,GAAWC,OAAX,EAAX;AACA,MAAIF,MAAMH,UAAV,EAAsB;AACpB,WAAO,IAAP;AACD,GAFD,MAGI;AACF,WAAO,KAAP;AACD;AACF,CAbD;;AAeAhB,OAAOiB,SAAP,CAAiBL,iBAAjB,GAAqC,YAAY;AAC/C,MAAIT,QAAQ,KAAKA,KAAjB;AACA,MAAIC,YAAY,KAAKA,SAArB;AACA,MAAIkB,MAAMxB,IAAIC,WAAJ,GAAkB,SAAlB,GAA8BI,KAA9B,GAAsC,UAAtC,GAAmDC,SAA7D;AACAmB,UAAQC,GAAR,CAAYF,GAAZ;AACA,SAAO,IAAI7B,OAAJ,CAAY,UAAUqB,OAAV,EAAmBW,MAAnB,EAA2B;AAC5C9B,YAAQ;AACN2B,WAAKA,GADC;AAENI,YAAM;AAFA,KAAR,EAGGnB,IAHH,CAGQ,UAAUoB,QAAV,EAAoB;AAC1BJ,cAAQC,GAAR,CAAYG,SAASC,IAArB;AACA,UAAIpB,OAAOmB,SAASC,IAApB;AACA,UAAIT,MAAM,IAAIC,IAAJ,GAAWC,OAAX,EAAV;AACA,UAAIL,aAAaG,MAAM,CAACX,KAAKQ,UAAL,GAAkB,EAAnB,IAAyB,IAAhD;AACAR,WAAKQ,UAAL,GAAkBA,UAAlB;AACAF,cAAQN,IAAR;AACD,KAVD;AAWD,GAZM,CAAP;AAaD,CAlBD;;AAoBAqB,OAAOC,OAAP,GAAiB9B,MAAjB","file":"wechat.js","sourcesContent":["var Promise = require('bluebird')\nvar request = Promise.promisify(require('request'))\n// var request = require('request')\nvar prefix = 'https://api.weixin.qq.com/cgi-bin/'\nvar api = {\n  accessToken: prefix + 'token?grant_type=client_credential'\n}\nfunction Wechat(opts) {\n  var that = this\n  this.appID = opts.appID\n  this.appSecret = opts.appSecret\n  this.getAccessToken = opts.getAccessToken\n  this.saveAccessToken = opts.saveAccessToken\n  this.getAccessToken()\n    .then(function(data) {\n      try {\n        data = JSON.parse(data)\n      }\n      catch (e) {\n        return that.updateAccessToken(data)\n      }\n      if (that.isValidAccessToken(data)) {\n        Promise.resolve(data)\n      }\n      else {\n        return that.updateAccessToken()\n      }\n    })\n    .then(function (data) {\n      that.access_token = data.access_token\n      that.expires_in = data.expires_in\n      that.saveAccessToken(data)\n    })\n}\n\nWechat.prototype.isValidAccessToken = function (data) {\n  if(!data || !data.acces_token || !data.expires_in) {\n    return false\n  }\n  var access_token = data.acces_token\n  var expires_in = data.expires_in\n  var now = (new Date().getTime())\n  if( now < expires_in) {\n    return true\n  }\n  else{\n    return false\n  }\n}\n\nWechat.prototype.updateAccessToken = function () {\n  var appID = this.appID\n  var appSecret = this.appSecret\n  var url = api.accessToken + '&appid=' + appID + '&secret=' + appSecret\n  console.log(url)\n  return new Promise(function (resolve, reject) {\n    request({\n      url: url,\n      json: true\n    }).then(function (response) {\n      console.log(response.body)\n      var data = response.body\n      var now = new Date().getTime()\n      var expires_in = now + (data.expires_in - 20) * 1000\n      data.expires_in = expires_in\n      resolve(data)\n    })\n  })\n}\n\nmodule.exports = Wechat"]}